apiVersion: v1
kind: Pod
metadata:
  labels:
    app: test-kata-qemu-security-1
  name: test-kata-qemu-security-1
  annotations:
    io.containerd.cri.runtime-handler: kata-qemu-security
spec:
  restartPolicy: Always
  runtimeClassName: kata-qemu-security
  volumes:
  - name: jfs-share
    emptyDir:
      medium: Memory
      sizeLimit: 10Mi
  - name: block-volume-ceph
    persistentVolumeClaim:
      claimName: cfs-security-kbs-pvc
  containers:
  - name: device-sidecar-1
    #image: hub.confidentialfilesystems.com:4443/cc/juicedata-juicefs-sidecar:v1.1.2-filesystem-1
    #image: hub.confidentialfilesystems.com:4443/cc/coco-trustee:v0.8.0-filesystem-1
    image: hub.idoe.space/blockchain/cc/cfs-benchmark:v0.0.4
    lifecycle:
      preStop:
        exec:
          command:
          - sh
          - -c
          - close_block_device.sh cfs-ceph /jfs/share/cfs
    command:
    - sh
    - -c
    - |-
      open_block_device.sh /dev/block-ceph cfs-ceph /jfs/share/cfs /home/tmp/fsrk
      while true; do sleep 60; done
    resources:
      limits:
        cpu: '2'
        memory: 8Gi
      requests:
        cpu: '2'
        memory: 8Gi
    securityContext:
      privileged: true
    volumeDevices:
      - name: block-volume-ceph
        devicePath: /dev/block-ceph
    volumeMounts:
      - name: jfs-share
        mountPath: /jfs/share
        mountPropagation: Bidirectional
  - name: cfs-security-1
    image: hub.confidentialfilesystems.com:4443/cc/coco-trustee:v0.8.0-filesystem-1
    imagePullPolicy: Always
    volumeMounts:
      - name: jfs-share
        mountPath: /opt/confidential-containers/kbs # use in /opt/confidential-containers/kbs/repository
    securityContext:
      privileged: true
  - name: ownership-db-1
    #image: hub.confidentialfilesystems.com:4443/cc/postgres:12.19-alpine
    image: hub.confidentialfilesystems.com:4443/cc/postgres:12-alpine
    imagePullPolicy: Always
    env:
      - name: POSTGRES_DB
        value: postgres
      - name: POSTGRES_USER
        value: postgres
      - name: POSTGRES_PASSWORD
        value: "123456"
      - name: PGDATA
        value: /var/lib/postgresql/data
    ports:
      - containerPort: 5432
    volumeMounts:
      - name: jfs-share
        mountPath: /var/lib/postgresql
---
apiVersion: v1
kind: Service
metadata:
  name: test-kata-qemu-security-1-svc
spec:
  type: NodePort
  ports:
    - name: https-rest
      port: 11111
      nodePort: 31111
      targetPort: 11111
  selector:
    app: test-kata-qemu-security-1